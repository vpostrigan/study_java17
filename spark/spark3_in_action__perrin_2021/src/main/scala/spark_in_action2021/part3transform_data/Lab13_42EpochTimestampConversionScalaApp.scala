package spark_in_action2021.part3transform_data

import java.util.{ArrayList, Random}

import org.apache.spark.sql.types.{DataTypes, StructField, StructType}
import org.apache.spark.sql.{Row, RowFactory, SparkSession, functions => F}

/**
 * Use of from_unixtime() and unix_timestamp().
 *
 * @author rambabu.posa
 */
object Lab13_42EpochTimestampConversionScalaApp {

  def main(args: Array[String]): Unit = {
    val spark: SparkSession = SparkSession.builder
      .appName("Timestamp conversion")
      .master("local[*]")
      .getOrCreate

    val schema: StructType = DataTypes.createStructType(Array[StructField](
      DataTypes.createStructField("event", DataTypes.IntegerType, false),
      DataTypes.createStructField("original_ts", DataTypes.StringType, false)))

    // Building a df with a sequence of chronological timestamps
    val rows = new ArrayList[Row]
    var now = System.currentTimeMillis / 1000
    for (i <- 0 until 50) {
      rows.add(RowFactory.create(int2Integer(i), String.valueOf(now)))
      now += new Random().nextInt(3) + 1
    }

    var df = spark.createDataFrame(rows, schema)
    df.show()
    df.printSchema()

    // Turning the timestamps to Timestamp datatype
    df = df.withColumn("date",
      F.from_unixtime(F.col("original_ts")).cast(DataTypes.TimestampType))

    df.show()
    df.printSchema()

    // Turning back the timestamps to epoch
    df = df.withColumn("epoch", F.unix_timestamp(F.col("date")))
    df.show()
    df.printSchema()

    // Collecting the result and printing ou
    val timeRows = df.collectAsList
    import scala.collection.JavaConversions._
    for (r <- timeRows) {
      printf("[%d] : %s (%s)\n", r.getInt(0), r.getAs("epoch"), r.getAs("date"))
    }

    spark.stop
  }

}
/*
+-----+-----------+
|event|original_ts|
+-----+-----------+
|    0| 1666604979|
|    1| 1666604982|
|    2| 1666604984|
|    3| 1666604985|
|    4| 1666604986|
|    5| 1666604988|
|    6| 1666604991|
|    7| 1666604993|
|    8| 1666604994|
|    9| 1666604995|
|   10| 1666604998|
|   11| 1666605000|
|   12| 1666605003|
|   13| 1666605006|
|   14| 1666605008|
|   15| 1666605009|
|   16| 1666605011|
|   17| 1666605013|
|   18| 1666605014|
|   19| 1666605016|
+-----+-----------+
only showing top 20 rows

root
 |-- event: integer (nullable = false)
 |-- original_ts: string (nullable = false)

+-----+-----------+-------------------+
|event|original_ts|               date|
+-----+-----------+-------------------+
|    0| 1666604979|2022-10-24 12:49:39|
|    1| 1666604982|2022-10-24 12:49:42|
|    2| 1666604984|2022-10-24 12:49:44|
|    3| 1666604985|2022-10-24 12:49:45|
|    4| 1666604986|2022-10-24 12:49:46|
|    5| 1666604988|2022-10-24 12:49:48|
|    6| 1666604991|2022-10-24 12:49:51|
|    7| 1666604993|2022-10-24 12:49:53|
|    8| 1666604994|2022-10-24 12:49:54|
|    9| 1666604995|2022-10-24 12:49:55|
|   10| 1666604998|2022-10-24 12:49:58|
|   11| 1666605000|2022-10-24 12:50:00|
|   12| 1666605003|2022-10-24 12:50:03|
|   13| 1666605006|2022-10-24 12:50:06|
|   14| 1666605008|2022-10-24 12:50:08|
|   15| 1666605009|2022-10-24 12:50:09|
|   16| 1666605011|2022-10-24 12:50:11|
|   17| 1666605013|2022-10-24 12:50:13|
|   18| 1666605014|2022-10-24 12:50:14|
|   19| 1666605016|2022-10-24 12:50:16|
+-----+-----------+-------------------+
only showing top 20 rows

root
 |-- event: integer (nullable = false)
 |-- original_ts: string (nullable = false)
 |-- date: timestamp (nullable = true)

+-----+-----------+-------------------+----------+
|event|original_ts|               date|     epoch|
+-----+-----------+-------------------+----------+
|    0| 1666604979|2022-10-24 12:49:39|1666604979|
|    1| 1666604982|2022-10-24 12:49:42|1666604982|
|    2| 1666604984|2022-10-24 12:49:44|1666604984|
|    3| 1666604985|2022-10-24 12:49:45|1666604985|
|    4| 1666604986|2022-10-24 12:49:46|1666604986|
|    5| 1666604988|2022-10-24 12:49:48|1666604988|
|    6| 1666604991|2022-10-24 12:49:51|1666604991|
|    7| 1666604993|2022-10-24 12:49:53|1666604993|
|    8| 1666604994|2022-10-24 12:49:54|1666604994|
|    9| 1666604995|2022-10-24 12:49:55|1666604995|
|   10| 1666604998|2022-10-24 12:49:58|1666604998|
|   11| 1666605000|2022-10-24 12:50:00|1666605000|
|   12| 1666605003|2022-10-24 12:50:03|1666605003|
|   13| 1666605006|2022-10-24 12:50:06|1666605006|
|   14| 1666605008|2022-10-24 12:50:08|1666605008|
|   15| 1666605009|2022-10-24 12:50:09|1666605009|
|   16| 1666605011|2022-10-24 12:50:11|1666605011|
|   17| 1666605013|2022-10-24 12:50:13|1666605013|
|   18| 1666605014|2022-10-24 12:50:14|1666605014|
|   19| 1666605016|2022-10-24 12:50:16|1666605016|
+-----+-----------+-------------------+----------+
only showing top 20 rows

root
 |-- event: integer (nullable = false)
 |-- original_ts: string (nullable = false)
 |-- date: timestamp (nullable = true)
 |-- epoch: long (nullable = true)

[0] : 1666604979 (2022-10-24 12:49:39.0)
[1] : 1666604982 (2022-10-24 12:49:42.0)
[2] : 1666604984 (2022-10-24 12:49:44.0)
[3] : 1666604985 (2022-10-24 12:49:45.0)
[4] : 1666604986 (2022-10-24 12:49:46.0)
[5] : 1666604988 (2022-10-24 12:49:48.0)
[6] : 1666604991 (2022-10-24 12:49:51.0)
[7] : 1666604993 (2022-10-24 12:49:53.0)
[8] : 1666604994 (2022-10-24 12:49:54.0)
[9] : 1666604995 (2022-10-24 12:49:55.0)
[10] : 1666604998 (2022-10-24 12:49:58.0)
[11] : 1666605000 (2022-10-24 12:50:00.0)
[12] : 1666605003 (2022-10-24 12:50:03.0)
[13] : 1666605006 (2022-10-24 12:50:06.0)
[14] : 1666605008 (2022-10-24 12:50:08.0)
[15] : 1666605009 (2022-10-24 12:50:09.0)
[16] : 1666605011 (2022-10-24 12:50:11.0)
[17] : 1666605013 (2022-10-24 12:50:13.0)
[18] : 1666605014 (2022-10-24 12:50:14.0)
[19] : 1666605016 (2022-10-24 12:50:16.0)
[20] : 1666605017 (2022-10-24 12:50:17.0)
[21] : 1666605019 (2022-10-24 12:50:19.0)
[22] : 1666605022 (2022-10-24 12:50:22.0)
[23] : 1666605023 (2022-10-24 12:50:23.0)
[24] : 1666605025 (2022-10-24 12:50:25.0)
[25] : 1666605027 (2022-10-24 12:50:27.0)
[26] : 1666605028 (2022-10-24 12:50:28.0)
[27] : 1666605030 (2022-10-24 12:50:30.0)
[28] : 1666605032 (2022-10-24 12:50:32.0)
[29] : 1666605034 (2022-10-24 12:50:34.0)
[30] : 1666605037 (2022-10-24 12:50:37.0)
[31] : 1666605039 (2022-10-24 12:50:39.0)
[32] : 1666605040 (2022-10-24 12:50:40.0)
[33] : 1666605041 (2022-10-24 12:50:41.0)
[34] : 1666605042 (2022-10-24 12:50:42.0)
[35] : 1666605044 (2022-10-24 12:50:44.0)
[36] : 1666605045 (2022-10-24 12:50:45.0)
[37] : 1666605046 (2022-10-24 12:50:46.0)
[38] : 1666605047 (2022-10-24 12:50:47.0)
[39] : 1666605049 (2022-10-24 12:50:49.0)
[40] : 1666605051 (2022-10-24 12:50:51.0)
[41] : 1666605053 (2022-10-24 12:50:53.0)
[42] : 1666605054 (2022-10-24 12:50:54.0)
[43] : 1666605055 (2022-10-24 12:50:55.0)
[44] : 1666605056 (2022-10-24 12:50:56.0)
[45] : 1666605059 (2022-10-24 12:50:59.0)
[46] : 1666605061 (2022-10-24 12:51:01.0)
[47] : 1666605062 (2022-10-24 12:51:02.0)
[48] : 1666605064 (2022-10-24 12:51:04.0)
[49] : 1666605066 (2022-10-24 12:51:06.0)
 */