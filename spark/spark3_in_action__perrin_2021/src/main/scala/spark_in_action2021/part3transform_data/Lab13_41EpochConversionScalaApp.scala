package spark_in_action2021.part3transform_data

import java.util.{ArrayList, Random}

import org.apache.spark.sql.types.{DataTypes, StructField}
import org.apache.spark.sql.{Row, RowFactory, SparkSession, functions => F}

/**
 * Use of from_unixtime().
 *
 * @author rambabu.posa
 */
object Lab13_41EpochConversionScalaApp {

  def main(args: Array[String]): Unit = {

    val spark: SparkSession = SparkSession.builder
      .appName("from_unixtime()")
      .master("local[*]")
      .getOrCreate

    val schema = DataTypes.createStructType(Array[StructField](
      DataTypes.createStructField("event", DataTypes.IntegerType, false),
      DataTypes.createStructField("ts", DataTypes.StringType, false)))

    // Building a df with a sequence of chronological timestamps
    val rows = new ArrayList[Row]
    var now:Long = System.currentTimeMillis / 1000
    for (i <- 0 until 50) {
      rows.add(RowFactory.create(int2Integer(i), String.valueOf(now)))
      now += new Random().nextInt(3) + 1
    }

    var df = spark.createDataFrame(rows, schema)
    df.show()

    // Turning the timestamps to dates
    df = df.withColumn("date", F.from_unixtime(F.col("ts")))
    df.show()

    // Collecting the result and printing out
    val timeRows = df.collectAsList
    import scala.collection.JavaConversions._
    for (r <- timeRows) {
      printf("[%d] : %s (%s)\n", r.getInt(0), r.getString(1), r.getString(2))
    }

    spark.stop
  }

}
/*
+-----+----------+
|event|        ts|
+-----+----------+
|    0|1666602012|
|    1|1666602015|
|    2|1666602018|
|    3|1666602019|
|    4|1666602022|
|    5|1666602024|
|    6|1666602025|
|    7|1666602027|
|    8|1666602029|
|    9|1666602032|
|   10|1666602035|
|   11|1666602037|
|   12|1666602039|
|   13|1666602041|
|   14|1666602043|
|   15|1666602045|
|   16|1666602048|
|   17|1666602050|
|   18|1666602053|
|   19|1666602055|
+-----+----------+
only showing top 20 rows

+-----+----------+-------------------+
|event|        ts|               date|
+-----+----------+-------------------+
|    0|1666602012|2022-10-24 12:00:12|
|    1|1666602015|2022-10-24 12:00:15|
|    2|1666602018|2022-10-24 12:00:18|
|    3|1666602019|2022-10-24 12:00:19|
|    4|1666602022|2022-10-24 12:00:22|
|    5|1666602024|2022-10-24 12:00:24|
|    6|1666602025|2022-10-24 12:00:25|
|    7|1666602027|2022-10-24 12:00:27|
|    8|1666602029|2022-10-24 12:00:29|
|    9|1666602032|2022-10-24 12:00:32|
|   10|1666602035|2022-10-24 12:00:35|
|   11|1666602037|2022-10-24 12:00:37|
|   12|1666602039|2022-10-24 12:00:39|
|   13|1666602041|2022-10-24 12:00:41|
|   14|1666602043|2022-10-24 12:00:43|
|   15|1666602045|2022-10-24 12:00:45|
|   16|1666602048|2022-10-24 12:00:48|
|   17|1666602050|2022-10-24 12:00:50|
|   18|1666602053|2022-10-24 12:00:53|
|   19|1666602055|2022-10-24 12:00:55|
+-----+----------+-------------------+
only showing top 20 rows

[0] : 1666602012 (2022-10-24 12:00:12)
[1] : 1666602015 (2022-10-24 12:00:15)
[2] : 1666602018 (2022-10-24 12:00:18)
[3] : 1666602019 (2022-10-24 12:00:19)
[4] : 1666602022 (2022-10-24 12:00:22)
[5] : 1666602024 (2022-10-24 12:00:24)
[6] : 1666602025 (2022-10-24 12:00:25)
[7] : 1666602027 (2022-10-24 12:00:27)
[8] : 1666602029 (2022-10-24 12:00:29)
[9] : 1666602032 (2022-10-24 12:00:32)
[10] : 1666602035 (2022-10-24 12:00:35)
[11] : 1666602037 (2022-10-24 12:00:37)
[12] : 1666602039 (2022-10-24 12:00:39)
[13] : 1666602041 (2022-10-24 12:00:41)
[14] : 1666602043 (2022-10-24 12:00:43)
[15] : 1666602045 (2022-10-24 12:00:45)
[16] : 1666602048 (2022-10-24 12:00:48)
[17] : 1666602050 (2022-10-24 12:00:50)
[18] : 1666602053 (2022-10-24 12:00:53)
[19] : 1666602055 (2022-10-24 12:00:55)
[20] : 1666602058 (2022-10-24 12:00:58)
[21] : 1666602061 (2022-10-24 12:01:01)
[22] : 1666602062 (2022-10-24 12:01:02)
[23] : 1666602063 (2022-10-24 12:01:03)
[24] : 1666602065 (2022-10-24 12:01:05)
[25] : 1666602067 (2022-10-24 12:01:07)
[26] : 1666602069 (2022-10-24 12:01:09)
[27] : 1666602070 (2022-10-24 12:01:10)
[28] : 1666602072 (2022-10-24 12:01:12)
[29] : 1666602073 (2022-10-24 12:01:13)
[30] : 1666602075 (2022-10-24 12:01:15)
[31] : 1666602077 (2022-10-24 12:01:17)
[32] : 1666602079 (2022-10-24 12:01:19)
[33] : 1666602082 (2022-10-24 12:01:22)
[34] : 1666602085 (2022-10-24 12:01:25)
[35] : 1666602088 (2022-10-24 12:01:28)
[36] : 1666602091 (2022-10-24 12:01:31)
[37] : 1666602092 (2022-10-24 12:01:32)
[38] : 1666602095 (2022-10-24 12:01:35)
[39] : 1666602097 (2022-10-24 12:01:37)
[40] : 1666602098 (2022-10-24 12:01:38)
[41] : 1666602099 (2022-10-24 12:01:39)
[42] : 1666602102 (2022-10-24 12:01:42)
[43] : 1666602104 (2022-10-24 12:01:44)
[44] : 1666602105 (2022-10-24 12:01:45)
[45] : 1666602107 (2022-10-24 12:01:47)
[46] : 1666602108 (2022-10-24 12:01:48)
[47] : 1666602109 (2022-10-24 12:01:49)
[48] : 1666602111 (2022-10-24 12:01:51)
[49] : 1666602112 (2022-10-24 12:01:52)
 */